# FrankenTUI CI/CD Pipeline
# bd-2nu8.13: Continuous integration for code quality and testing
#
# Runs on every PR and push to main branch.
# Matrix tests across OS and Rust versions.

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ==========================================================================
  # Check Job: Format, Clippy, Tests
  # ==========================================================================
  check:
    name: Check (${{ matrix.os }}, ${{ matrix.rust }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        rust: [stable, nightly]
        include:
          - os: windows-latest
            rust: stable

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}
          components: rustfmt, clippy

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ matrix.rust }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-${{ matrix.rust }}-

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run clippy
        run: cargo clippy --workspace --all-targets -- -D warnings

      - name: Enforce no-mock policy (bd-2nu8.18)
        run: |
          if rg -n -i '\b(mock|fake|stub)s?\b' crates tests -g '*.rs' \
            --glob '!crates/ftui-runtime/src/subscription.rs' \
            --glob '!crates/ftui-core/src/inline_mode.rs' \
            --glob '!crates/ftui-widgets/src/debug_overlay.rs' \
            --glob '!crates/ftui-render/src/sanitize.rs'; then
            echo "No-mock policy violation detected. See docs/testing/no-mock-policy.md."
            exit 1
          fi

      - name: Build workspace
        run: cargo build --workspace

      - name: Run tests
        run: cargo test --workspace --lib

      - name: Run tests (all features)
        run: cargo test --workspace --all-features
        if: matrix.rust == 'nightly'

  # ==========================================================================
  # Docs Job: Rustdoc + Examples
  # ==========================================================================
  docs:
    name: Docs (rustdoc + examples)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-docs-nightly-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-docs-nightly-

      - name: Run rustdoc tests
        run: cargo test --doc --workspace

      - name: Build ftui-harness examples
        run: cargo build --examples -p ftui-harness

  # ==========================================================================
  # Feature Combinations Job
  # ==========================================================================
  features:
    name: Feature Combinations
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly
          components: rustfmt, clippy

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-features-${{ hashFiles('**/Cargo.lock') }}

      - name: Test ftui-extras features
        run: |
          for feature in canvas charts forms markdown export clipboard syntax image live logging filepicker; do
            echo "Testing ftui-extras --features $feature"
            cargo check -p ftui-extras --features "$feature"
          done

      - name: Test ftui-widgets features
        run: cargo check -p ftui-widgets --features debug-overlay

      - name: Test no default features
        run: cargo check --workspace --no-default-features

  # ==========================================================================
  # Coverage Job
  # ==========================================================================
  coverage:
    name: Coverage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly
          components: llvm-tools-preview

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-coverage-${{ hashFiles('**/Cargo.lock') }}

      - name: Generate coverage
        run: cargo llvm-cov --workspace --all-targets --all-features --lcov --output-path lcov.info

      - name: Enforce coverage thresholds
        run: |
          python - <<'PY'
          from __future__ import annotations

          import os
          from pathlib import Path
          import sys

          lcov_path = Path("lcov.info")
          if not lcov_path.exists():
              raise SystemExit("lcov.info not found; coverage gate cannot run")

          def threshold(crate: str, default: float) -> float:
              env_key = f"COVERAGE_MIN_{crate.upper().replace('-', '_')}"
              raw = os.environ.get(env_key)
              if raw is None:
                  return default
              try:
                  return float(raw)
              except ValueError as exc:
                  raise SystemExit(f"Invalid {env_key}={raw!r}: {exc}") from exc

          thresholds = {
              # Correctness-critical crates get stricter floors.
              "ftui-render": threshold("ftui-render", 85.0),
              "ftui-core": threshold("ftui-core", 85.0),
              "ftui-style": threshold("ftui-style", 80.0),
              "ftui-text": threshold("ftui-text", 80.0),
              "ftui-layout": threshold("ftui-layout", 75.0),
              "ftui-runtime": threshold("ftui-runtime", 75.0),
              "ftui-widgets": threshold("ftui-widgets", 70.0),
              "ftui-extras": threshold("ftui-extras", 60.0),
          }
          overall_raw = os.environ.get("COVERAGE_MIN_OVERALL", "75.0")
          try:
              overall_target = float(overall_raw)
          except ValueError as exc:
              raise SystemExit(f"Invalid COVERAGE_MIN_OVERALL={overall_raw!r}: {exc}") from exc

          crate_totals = {crate: {"LF": 0, "LH": 0} for crate in thresholds}
          overall = {"LF": 0, "LH": 0}

          current = None
          for raw in lcov_path.read_text().splitlines():
              line = raw.strip()
              if line.startswith("SF:"):
                  current = {"file": line[3:], "LF": 0, "LH": 0}
              elif line.startswith("LF:") and current is not None:
                  current["LF"] = int(line[3:])
              elif line.startswith("LH:") and current is not None:
                  current["LH"] = int(line[3:])
              elif line == "end_of_record" and current is not None:
                  overall["LF"] += current["LF"]
                  overall["LH"] += current["LH"]
                  marker = "/crates/"
                  path = current["file"]
                  if marker in path:
                      crate = path.split(marker, 1)[1].split("/", 1)[0]
                      if crate in crate_totals:
                          crate_totals[crate]["LF"] += current["LF"]
                          crate_totals[crate]["LH"] += current["LH"]
                  current = None

          def pct(hit: int, total: int) -> float:
              return 0.0 if total == 0 else (100.0 * hit / total)

          failures = []
          for crate, totals in sorted(crate_totals.items()):
              value = pct(totals["LH"], totals["LF"])
              target = thresholds[crate]
              delta = value - target
              if delta < 0:
                  failures.append((crate, value, target, delta))

          overall_pct = pct(overall["LH"], overall["LF"])
          if overall_pct < overall_target:
              failures.append(("overall", overall_pct, overall_target, overall_pct - overall_target))

          if failures:
              print("Coverage gate failed:")
              for crate, value, target, delta in failures:
                  print(f"- {crate}: {value:.2f}% (target {target:.2f}%, delta {delta:.2f}%)")
              sys.exit(1)

          print(f"Coverage gate passed: overall {overall_pct:.2f}% (target {overall_target:.2f}%)")
          for crate, totals in sorted(crate_totals.items()):
              value = pct(totals["LH"], totals["LF"])
              target = thresholds[crate]
              delta = value - target
              print(f"- {crate}: {value:.2f}% (target {target:.2f}%, delta {delta:+.2f}%)")
          PY

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: lcov.info
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # ==========================================================================
  # Benchmarks Job (push to main only)
  # ==========================================================================
  benchmarks:
    name: Benchmarks
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-bench-${{ hashFiles('**/Cargo.lock') }}

      - name: Run benchmarks
        run: |
          # Core render benchmarks
          cargo bench -p ftui-render --bench cell_bench -- --output-format bencher | tee bench-output.txt
          cargo bench -p ftui-render --bench diff_bench -- --output-format bencher | tee -a bench-output.txt
          cargo bench -p ftui-render --bench buffer_bench -- --output-format bencher | tee -a bench-output.txt
          cargo bench -p ftui-render --bench presenter_bench -- --output-format bencher | tee -a bench-output.txt
          # Layout and text benchmarks
          cargo bench -p ftui-layout --bench layout_bench -- --output-format bencher | tee -a bench-output.txt
          cargo bench -p ftui-text --bench width_bench -- --output-format bencher | tee -a bench-output.txt
          # Widget benchmarks (bd-3cwi)
          cargo bench -p ftui-widgets --bench widget_bench -- --output-format bencher | tee -a bench-output.txt

      - name: Run budget enforcement (bd-3cwi)
        run: ./scripts/bench_budget.sh --check-only || echo "Budget check completed (warn-only)"
        continue-on-error: true

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: bench-output.txt
          retention-days: 30

  # ==========================================================================
  # Documentation Job
  # ==========================================================================
  docs:
    name: Documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-docs-${{ hashFiles('**/Cargo.lock') }}

      - name: Build documentation
        run: cargo doc --workspace --no-deps
        env:
          RUSTDOCFLAGS: -D warnings

      - name: Upload docs artifact
        uses: actions/upload-artifact@v4
        with:
          name: documentation
          path: target/doc
          retention-days: 7

  # ==========================================================================
  # Widget API E2E Test Job
  # ==========================================================================
  e2e-widget-api:
    name: Widget API E2E
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-e2e-widget-${{ hashFiles('**/Cargo.lock') }}

      - name: Run Widget API E2E tests
        env:
          E2E_JSONL_VALIDATE: "1"
          E2E_JSONL_VALIDATE_MODE: strict
        run: ./scripts/widget_api_e2e.sh

      - name: Validate Widget API E2E JSONL logs
        if: always()
        run: |
          set -euo pipefail
          shopt -s nullglob
          files=(/tmp/widget_api_e2e_*/widget_api_e2e.jsonl)
          if (( ${#files[@]} == 0 )); then
            echo "No widget API JSONL logs found under /tmp/widget_api_e2e_*/widget_api_e2e.jsonl"
            exit 1
          fi
          for file in "${files[@]}"; do
            echo "Validating $file"
            python3 tests/e2e/lib/validate_jsonl.py "$file" \
              --schema tests/e2e/lib/e2e_jsonl_schema.json \
              --registry tests/e2e/lib/e2e_hash_registry.json \
              --strict
          done

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: widget-api-e2e-logs
          path: /tmp/widget_api_e2e_*/
          retention-days: 7

  # ==========================================================================
  # Demo Showcase E2E Job
  # ==========================================================================
  demo-showcase:
    name: Demo Showcase
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly
          components: rustfmt, clippy

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-demo-showcase-${{ hashFiles('**/Cargo.lock') }}

      - name: Run demo showcase E2E tests
        env:
          E2E_JSONL_VALIDATE: "1"
          E2E_JSONL_VALIDATE_MODE: strict
        run: ./scripts/demo_showcase_e2e.sh

      - name: Validate demo showcase JSONL logs
        if: always()
        run: |
          set -euo pipefail
          shopt -s nullglob
          files=(/tmp/ftui-demo-e2e-*/demo_showcase_e2e.jsonl)
          if (( ${#files[@]} == 0 )); then
            echo "No demo showcase JSONL logs found under /tmp/ftui-demo-e2e-*/demo_showcase_e2e.jsonl"
            exit 1
          fi
          for file in "${files[@]}"; do
            echo "Validating $file"
            python3 tests/e2e/lib/validate_jsonl.py "$file" \
              --schema tests/e2e/lib/e2e_jsonl_schema.json \
              --registry tests/e2e/lib/e2e_hash_registry.json \
              --strict
          done

      - name: Run snapshot tests
        run: cargo test -p ftui-demo-showcase --test screen_snapshots

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: demo-showcase-e2e-logs
          path: /tmp/ftui-demo-e2e-*/
          retention-days: 7

  # ==========================================================================
  # PTY E2E Test Job (harness + terminal tests)
  # ==========================================================================
  e2e-pty:
    name: PTY E2E (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-e2e-pty-${{ hashFiles('**/Cargo.lock') }}

      - name: Run PTY E2E tests
        env:
          E2E_JSONL_VALIDATE: "1"
          E2E_JSONL_VALIDATE_MODE: strict
        run: ./scripts/e2e_test.sh

      - name: Validate PTY E2E JSONL logs
        if: always()
        run: |
          set -euo pipefail
          shopt -s nullglob
          files=(/tmp/ftui_e2e_*/e2e.jsonl)
          if (( ${#files[@]} == 0 )); then
            echo "No PTY E2E JSONL logs found under /tmp/ftui_e2e_*/e2e.jsonl"
            exit 1
          fi
          for file in "${files[@]}"; do
            echo "Validating $file"
            python3 tests/e2e/lib/validate_jsonl.py "$file" \
              --schema tests/e2e/lib/e2e_jsonl_schema.json \
              --registry tests/e2e/lib/e2e_hash_registry.json \
              --strict
          done

      - name: Upload E2E logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-pty-logs-${{ matrix.os }}
          path: /tmp/ftui_e2e_*/
          retention-days: 7

      - name: Upload test summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-pty-summary-${{ matrix.os }}
          path: /tmp/ftui_e2e_*/results/summary.json
          retention-days: 7
          if-no-files-found: ignore

  # ==========================================================================
  # Fuzz Build Check
  # ==========================================================================
  fuzz:
    name: Fuzz Build Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly

      - name: Install cargo-fuzz
        run: cargo install cargo-fuzz

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-fuzz-${{ hashFiles('**/Cargo.lock') }}

      - name: Build fuzz targets
        run: cargo fuzz build

      - name: Quick fuzz run (60s per target)
        run: |
          cargo fuzz run fuzz_input_parser -- -max_len=4096 -max_total_time=20
          cargo fuzz run fuzz_input_parser_structured -- -max_len=4096 -max_total_time=20
          cargo fuzz run fuzz_input_parser_long_seq -- -max_total_time=20

  # ==========================================================================
  # MSRV Check (Minimum Supported Rust Version)
  # ==========================================================================
  msrv:
    name: MSRV Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          # Using nightly as MSRV since project requires edition 2024
          toolchain: nightly

      - name: Check MSRV
        run: cargo check --workspace

  # ==========================================================================
  # WASM Build Check (host-agnostic surfaces)
  # ==========================================================================
  wasm:
    name: WASM Build Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly

      - name: Install wasm32 target
        run: rustup target add wasm32-unknown-unknown

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-wasm-${{ hashFiles('**/Cargo.lock') }}

      - name: Check host-agnostic crates for wasm32-unknown-unknown
        run: |
          set -euo pipefail
          cargo check --target wasm32-unknown-unknown -p ftui-core
          cargo check --target wasm32-unknown-unknown -p ftui-render
          cargo check --target wasm32-unknown-unknown -p ftui-style
          cargo check --target wasm32-unknown-unknown -p ftui-layout
          cargo check --target wasm32-unknown-unknown -p ftui-text
          cargo check --target wasm32-unknown-unknown -p ftui-i18n
          cargo check --target wasm32-unknown-unknown -p frankenterm-core
          cargo check --target wasm32-unknown-unknown -p frankenterm-web
